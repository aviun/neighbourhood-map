var map="",applyMapStyles=function(){var styleArray=[{featureType:"all",stylers:[{visibility:"off"}]},{featureType:"road",stylers:[{visibility:"on"}]},{featureType:"landscape",stylers:[{visibility:"on"}]},{featureType:"water",stylers:[{visibility:"on"}]}];map.setOptions({styles:styleArray})},initMap=function(){try{map=new google.maps.Map(document.getElementById("map"),{zoom:12,center:new google.maps.LatLng(50.442,30.548),mapTypeId:google.maps.MapTypeId.ROADMAP}),applyMapStyles(),viewModel.init()}catch(error){alert("Unable to connect to Google Maps. Error: "+error)}},viewModel={self:this,locations:ko.observableArray(),searchQuery:ko.observable(""),toggleMarker:function(location){viewModel.disableMarkers(),location.marker.setAnimation(google.maps.Animation.BOUNCE),location.infowindow.open(map,location.marker)},disableMarkers:function(){for(var i=0;i<this.locations().length;i++)this.locations()[i].marker.setAnimation(null),this.locations()[i].infowindow.close()},fillLocations:function(){for(var i=0;i<model.locations.length;i++)this.locations.push(model.locations[i])},init:function(){model.init(),this.fillLocations(),ko.applyBindings(viewModel),viewModel.searchQuery.subscribe(this.filterItems)},filterItems:function(){for(var filter=viewModel.searchQuery().toLowerCase(),i=0;i<model.locations.length;i++){var searchedTitle=model.locations[i].title().toLowerCase();searchedTitle.indexOf(filter)>-1?(model.locations[i].isFiltered(!0),model.locations[i].marker.setMap(map)):(model.locations[i].isFiltered(!1),model.locations[i].marker.setMap(null))}}},model={self:this,locations:[{title:ko.observable("Khreshchatyk"),lat:50.44,lng:30.51,isFiltered:ko.observable(!0)},{title:ko.observable("Maidan Nezalezhnosti"),lat:50.44,lng:30.52,isFiltered:ko.observable(!0)},{title:ko.observable("Mariyinsky Palace"),lat:50.44,lng:30.53,isFiltered:ko.observable(!0)},{title:ko.observable("Kiev Pechersk Lavra"),lat:50.43,lng:30.55,isFiltered:ko.observable(!0)},{title:ko.observable("Saint Sophia's Cathedral, Kiev"),lat:50.45,lng:30.51,isFiltered:ko.observable(!0)},{title:ko.observable("Berehynia"),lat:50.45,lng:30.524,isFiltered:ko.observable(!0)},{title:ko.observable("Red University Building"),lat:50.442,lng:30.511,isFiltered:ko.observable(!0)}],setContent:function(){function getWikiExtract(i,wikiRequestTimeout,wikiURL){var result="";$.ajax({url:wikiURL,dataType:"jsonp",success:function(data){if(data&&data.query&&data.query.pages)var pages=data.query.pages;else result="No pages were found in Wiki",model.locations[i].infowindow=new google.maps.InfoWindow({content:model.locations[i].title()+"<br><br>Wikipedia info:<br>"+result});for(var id in pages)result=pages[id].extract,model.locations[i].infowindow=new google.maps.InfoWindow({content:'<div style="width: 95%; height:200px;" <strong><b>'+model.locations[i].title()+"</b></strong><br><br>Wikipedia info:<br>"+result+"</div>",maxWidth:"200"});clearTimeout(wikiRequestTimeout)},fail:function(){alert("Unable to reach Wikipedia"),model.locations[i].infowindow=new google.maps.InfoWindow({content:model.locations[i].title()+"<br><br>Wikipedia info:<br>Unavailable"})}})}for(var i=0;i<this.locations.length;i++)var wikiURL="https://en.wikipedia.org/w/api.php?format=json&action=query&prop=extracts&exintro=&explaintext=&titles="+this.locations[i].title(),wikiRequestTimeout=setTimeout(function(){article="failed to get Wiki resources"},8e3),article=getWikiExtract(i,wikiRequestTimeout,wikiURL)},addMarkers:function(){for(var i=0;i<this.locations.length;i++)this.locations[i].marker=this.createMarker(this.locations[i],i)},toggleBounce:function(location){viewModel.disableMarkers(),location.marker.setAnimation(google.maps.Animation.BOUNCE)},createMarker:function(location){var marker=new google.maps.Marker({title:location.title(),map:map,draggable:!1,animation:google.maps.Animation.DROP,position:new google.maps.LatLng(location.lat,location.lng)});return marker.addListener("click",function(){model.toggleBounce(location),location.infowindow.open(map,marker)}),marker},init:function(){this.addMarkers(),this.setContent()}};